<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Víctor Cantera">
        <link rel="icon" href="../../assets/img/comercia_ico.png" type="image/x-icon"/ >
        <title>Operativa Apple Pay JS</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="../../assets//js/javascript.js"></script>

        <!-- Bootstrap 4.3.1 -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

        <!-- CSS -->
        <link rel="stylesheet" href="../../assets/css/style.css">
    </head>

    <body>
        <!-- NAVBAR -->
        <nav class="navbar navbar-expand-lg navbar-light navbar-rpdc mb-3">
            <a class="navbar-brand">
                <img src="../../assets/img/log2.svg" width="30" height="30" class="img-fluid" alt="Logo Addon Payments">
                <span class="addonNav">ADDON</span> <span>PAYMENTS</span>
                <span class="d-none d-sm-none d-lg-inline d-xl-inline sdkNav">
                    <span>
                        /Apple
                        <span class="barraNav">_</span>
                        Pay
                        <span class="barraNav">_</span>
                        JS
                    </span>
                </span>

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
          </a>
            <div class="collapse navbar-collapse mb-2" id="navbarNav">
                <ul class="navbar-nav ml-auto pl-2 pr-2">
                    <li class="nav-item dropdown">
                        <a class="nav-link pl-2 dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Inicio
                        </a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item pl-2" href="../../index.html">Índice</a>
                            <a class="dropdown-item pl-2" href="../errores.html">Errores de Addon Payments</a>
                            <a class="dropdown-item pl-2" href="../informe.html">Convertir informe</a>
                        </div>
                    </li>
                    <li class="nav-item ml-1 dropdown">
                        <a class="nav-link pl-2 dropdown-toggle active" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Apple Pay
                        </a>
                        <div class="dropdown-menu dropdown-menu-right mb-2" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item pl-2 active" href="#">Operación Apple Pay JS</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <!-- /NAVBAR -->
        
        <div class="col-lg-12"> 
            <div id="contenidoComun" class="container-fluid">
                <div class="row">

                    <!-- Menú lateral -->
                    <div class="col-lg-2 sticky-top d-none d-sm-none d-lg-block d-xl-block MenuLateral">

                        <!-- Barra de progreso -->
                        <div class="progress-bar" id="progreso"></div>
                        <!-- /Barra de progreso -->

                        <nav class="navbar sticky-top navbar-light" style="padding: 0px;">
                            <nav class="nav nav-pills flex-column">
                                <a class="nav-link" href="#api">1. Apple Pay Javascript (web)</a>
                                <nav>
                                  <a class="nav-link ml-3 my-1" href="#codigoSesion">1.1 Obtener la sesión</a>
                                  <a class="nav-link ml-3 my-1" href="#codigoPhp">1.2 Autorización</a>
                                  <a class="nav-link ml-3 my-1" href="#codigoJs">1.3 JavaScript</a>
                                </nav>
                                <a class="nav-link" href="#certificados">2. Certificados</a>
                                <nav class="nav nav-pills flex-column">
                                  <a class="nav-link ml-3 my-1" href="#obtCsr">2.1 Obtener el certificado CSR</a>
                                  <a class="nav-link ml-3 my-1" href="#upCsr">2.2 Subir el CSR</a>
                                  <a class="nav-link ml-3 my-1" href="#upCsrAddon">2.3 Subir el CSR en el panel de administración</a>
                                </nav>
                                <a class="nav-link" href="#btnApplePay">3. Botón ApplePay</a>
                                <nav class="nav nav-pills flex-column">
                                    <a class="nav-link ml-3 my-1" href="#btnApplePay">3.1 Ejemplo</a>
                                </nav>
                            </nav>
                        </nav>
                    </div>
                    <!-- /Menú lateral -->

                    <!-- Contenido común -->
                    <div class="col-lg-10" >

						<!-- Punto 1-->
						<div class="contenedor">
							<div class="pl-3 pt-3 pr-3 pb-4 mb-3 text-justify">
								<h3 id="api" class="titulo">
									1. Apple Pay Javascript (web)
								</h3>
								<hr>

								<p>
                                    Para permitir los pagos con Apple Pay, debe programar su página web en base a las funciones de JavaScript implementadas en el navegador Safari.
                                </p>
                                <p>
                                    En esta documentación indicamos cómo realizar las peticiones desde nuestro Front a nuestro servidor para realizar los cobros y cómo obtener la sesión de Apple para poder procesar las solicitudes.
                                </p>
    
								<h5 class="pt-3" id="codigoSesion">1.1 Obtener la sesión</h5>

								<hr>

                                <p>
                                    Nosotros hemos realizado la integración de nuestro servidor con el SDK de PHP.
                                    <small class="form-text text-muted alert alert-primary">
                                        --&gt; Puede comprobar los SDK's que tenemos actualmente disponibles en <a target="_blank" href="https://github.com/addonpayments">nuestro GitHub</a>.
                                    </small>
                                </p>

								<div class="p-4 panelCode">
									<code>
										<b>
											<span class="etiqueta">&lt;?php</span>
										</b>
										<br>
                                        <br>
                                            <span class="pl-3 comments">// Cargamos los certificados solicitados por Apple</span>
                                        <br>
											<span class="pl-3 new">define('</span><span class="green">PRODUCTION_CERTIFICATE_KEY</span><span class="new">', </span><span class="green">Certificado.crt.pem</span><span class="new">');</span>
                                        <br>
                                            <span class="pl-3 new">define('</span><span class="green">PRODUCTION_CERTIFICATE_PATH</span><span class="new">', </span><span class="green">Certificado.key.pem</span><span class="new">');</span>
										<br>
										<br>
                                            <span class="pl-3 comments">// URL de validación de sesión de Apple</span>
                                        <br>
											<span class="pl-3">$</span><span class="white">validation_url </span><span class="new">= '</span><span class="green">https://apple-pay-gateway.apple.com/paymentservices/startSession</span><span class="new">';</span>
										<br>
                                        <br>
                                            <span class="pl-3 comments">// Iniciamos la petición Curl</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="white">ch </span><span class="new">= curl_init();</span>
                                        <br>
                                        <br>
                                            <span class="pl-3">$</span><span class="white">data </span><span class="new">= '</span><span class="green">{"merchantIdentifier":"DE.....AC", "domainName":"URL validada en Apple", "displayName":"Addon Payments"}</span><span class="new">';</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 new">curl_setopt(</span>$<span class="white">ch</span><span class="new">, </span><span class="orange">CURLOPT_URL</span><span class="new">, </span>$<span class="white">validation_url</span><span class="new">);</span>
                                        <br>
											<span class="pl-3 new">curl_setopt(</span>$<span class="white">ch</span><span class="new">, </span><span class="orange">CURLOPT_SSLCERT</span><span class="new">, </span><span class="new">PRODUCTION_CERTIFICATE_PATH</span><span class="new">);</span>
                                        <br>
											<span class="pl-3 new">curl_setopt(</span>$<span class="white">ch</span><span class="new">, </span><span class="orange">CURLOPT_SSLKEY</span><span class="new">, </span><span class="new">PRODUCTION_CERTIFICATE_KEY</span><span class="new">);</span>
                                        <br>
											<span class="pl-3 new">curl_setopt(</span>$<span class="white">ch</span><span class="new">, </span><span class="orange">CURLOPT_POST</span><span class="new">, </span><span class="orange">1</span><span class="new">);</span>
                                        <br>
											<span class="pl-3 new">curl_setopt(</span>$<span class="white">ch</span><span class="new">, </span><span class="orange">CURLOPT_POSTFIELDS</span><span class="new">, </span>$<span class="white">data</span><span class="new">);</span>
                                        <br>
										<br>
											<span class="pl-3 comments">// Comprobamos si hay algún error en la petición curl</span>
										<br>
											<span class="pl-3 purple">if</span><span class="new">(curl_exec(</span>$<span class="white">ch</span><span class="new">) === </span><span class="orange">false</span><span class="new">) {</span>
                                        <br>
											<span class="pl-5 new">echo '</span><span class="green">Error en la petición Curl: </span><span class="new">' .curl_error(</span>$<span class="white">ch</span><span class="new">);</span>
                                        <br>
											<span class="pl-3 new">}</span>
                                        <br>
                                        <br>
											<span class="pl-3 new">curl_close(</span>$<span class="white">ch</span><span class="new">);</span>
										<br>
										<br>
										<b>
											<span class="etiqueta">?&gt;</span>
										</b>
									</code>
								</div>

                                <h5 class="pt-4" id="codigoPhp">1.2 Autorización</h5>

                                <hr>

                                <p>
                                    Para realizar una autorización se debe facilitar el token que genera nuestra petición en JavaScript tras obtener la sesión a nuestro servidor con la librería de Addon Payments, la cual procesará la solicitud de pago.
                                </p>

                                <div class="p-4 panelCode">
                                    <code>
                                        <b>
                                            <span class="etiqueta">&lt;?php</span>
                                        </b>
                                        <br>
                                        <br>
                                            <span class="pl-3 comments">// Imports necesarios para realizar una aturoización</span>
                                        <br>
                                            <span class="pl-3 require">require_once('</span><span class="green">vendor/autoload.php</span><span class="require">');</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\ServicesConfig</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\ServicesContainer</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\PaymentMethods\CreditCardData</span><span class="pl-3 require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\Entities\Enums\EncyptedMobileType</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\Entities\Enums\TransactionModifier</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\Entities\Exceptions\ApiException</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3 require">use </span><span class="imports">AddonPayments\Api\Entities\Transaction</span><span class=" require">;</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 comments">// Configuración del terminal</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">config</span> <span class="require">=</span> <span class="new">new</span> <span class="yellow">ServicesConfig()</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">config</span><span class="require">-></span><span class="new">merchantId</span> <span class="require">= "</span><span class="green">Merchant_ID</span><span class="require">";</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">config</span><span class="require">-></span><span class="new">accountId</span> <span class="require">= "</span><span class="green">Sub_Account</span><span class="require">";</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">config</span><span class="require">-></span><span class="new">sharedSecret</span> <span class="require">= "</span><span class="green">Shared_Secret</span><span class="require">";</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">config</span><span class="require">-></span><span class="new">serviceUrl</span> <span class="require">= "</span><span class="green">https://remote.sandbox.addonpayments.com/remote</span><span class="require">";</span>
                                        <br>
                                            <span class="pl-3 yellow">ServicesContainer</span><span class="configure">::configure</span><span class="require">(</span>$<span class="new">config</span><span class="require">);</span>
                                        <br>
                                        <br>
                                            <span class="pl-3">$</span><span class="white">tokenFinal </span><span class="new">= </span>$<span class="white">_POST</span><span class="new">['</span><span class="green">misDatos</span><span class="new">'];</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 comments">// Creamos el objeto tarjeta</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">card</span> <span class="require">= </span><span class="purple">new</span> <span class="yellow">CreditCardData()</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">card</span><span class="require">-></span><span class="white">token</span> <span class="require">= </span>$<span class="white">tokenFinal</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-3">$</span><span class="new">card</span><span class="require">-></span><span class="white">mobileType </span> <span class="require">= </span><span class="yellow">EncyptedMobileType</span><span class="require">::</span><span class="white">APPLE_PAY</span><span class="require">;</span>
                                        <br>
                                        <br>
                                            <span class="pl-3">$</span><span class="white">response </span><span class="require">= </span><span class="purple">new </span><span class="yellow">Transaction()</span><span class="require">;</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 comments">// Lanzamos la petición al servidor de Addon Payments</span>
                                        <br>
                                            <span class="pl-3 new">try</span><span class="require"> {</span>
                                        <br>
                                            <span class="pl-4">$</span><span class="white">response</span> <span class="require">= </span>$<span class="white">card</span><span class="require">-></span><span class="configure">charge</span><span class="require">()</span>
                                        <br>
                                            <span class="pl-5 require">-></span><span class="configure">withModifier</span><span class="require">(</span><span class="yellow">TransactionModifier</span><span class="require">::ENCRYPTED_MOBILE)</span>
                                        <br>
                                            <span class="pl-5 require">-></span><span class="configure">execute</span><span class="require">(</span><span class="require">);</span>
                                        <br>
                                        <br>
                                            <span class="comments pl-4">// Obtenemos la respuesta y la devolvemos en formato JSON</span>
                                        <br>
                                            <span class="pl-4 require">header('</span><span class="green">Content-Type: application/json</span><span class="require">');</span>
                                        <br>
                                        <br>
                                            <span class="pl-4 require">echo json_encode(array(</span>
                                        <br>
                                            <span class="pl-5 require">'</span><span class="green">respuesta</span><span class="require">' => </span>$<span class="white">result </span><span class="require">= </span>$<span class="white">response</span><span class="require">-></span><span class="white">responseCode</span><span class="require">,</span>
                                        <br>
                                            <span class="pl-5 require">'</span><span class="green">mensaje</span><span class="require">' => </span>$<span class="white">message </span><span class="require">= </span>$<span class="white">response</span><span class="require">-></span><span class="white">responseMessage</span><span class="require">,</span>
                                        <br>
                                            <span class="pl-5 require">'</span><span class="green">orderid</span><span class="require">' => </span>$<span class="white">orderId </span><span class="require">= </span>$<span class="white">response</span><span class="require">-></span><span class="white">orderId</span><span class="require">,</span>
                                        <br>
                                            <span class="pl-5 require">'</span><span class="green">codeauth</span><span class="require">' => </span>$<span class="white">authCode </span><span class="require">= </span>$<span class="white">response</span><span class="require">-></span><span class="white">authorizationCode</span><span class="require">,</span>
                                        <br>
                                            <span class="pl-5 require">'</span><span class="green">pasref</span><span class="require">' => </span>$<span class="white">paymentsReference </span><span class="require">= </span>$<span class="white">response</span><span class="require">-></span><span class="white">transactionId</span>
                                        <br>
                                            <span class="pl-4 require">));</span>
                                        <br>
                                        <br>
                                            <span class="pl-4 require">exit;</span>
                                        <br>
                                        <br>
                                            <span class="pl-3 require">}</span><span class="new"> catch</span> (<span class="yellow">ApiException</span> $<span class="variables">e</span>) <span class="require">{</span>
                                        <br>
                                            <span class="comments pl-4">// Añada aquí su tratamiento de errores</span>
                                        <br>
                                            <span class="pl-4 require">echo</span> $<span class="variables">e</span><span class="require">-></span><span class="configure">getMessage</span><span class="require">();</span>
                                        <br>
                                            <span class="pl-3 require">}</span>
                                        <br>
                                        <br>
                                        <b>
                                            <span class="etiqueta">?&gt;</span>
                                        </b>
                                    </code>
                                </div>

                                <h5 class="pt-4" id="codigoJs">1.3 JavaScript</h5>

                                <hr>

                                <p>
                                    Con el código javascript que facilitamos a continuación podremos obtener la sesión y enviar la operación a nuestro servidor realizando peticiones asíncronas.
                                </p>

                                <div class="p-4 panelCode">
                                    <code>
                                            <span class="pl-2 new">&lt;</span><span class="script">button</span> <span class="new">type=</span><span class="require">"</span><span class="green">button</span><span class="require">" </span><span class="new"> id=</span><span class="require">"</span><span class="green">applePay</span><span class="require">"</span><span class="new">&gt;</span><span class="white">Comprar con ApplePay</span><span class="new">&lt;</span><span class="script">/button</span><span class="new">&gt;</span>
                                        <br>
                                        <br>
                                            <span class="pl-2 new">&lt;</span><span class="script">script</span><span class="new">&gt;</span>
                                        <br>
                                            <span class="pl-4">$</span><span class="require">(</span><span class="yellow">document</span><span class="require">).</span><span class="new">ready(</span><span class="function">function</span><span class="require">() {</span>
                                        <br>
                                            <span class="pl-5 comments">// Validamos que el cliente que se conecte sea bajo un dispositivo con Safari</span>
                                        <br>
                                            <span class="pl-5 function">if</span><span class="require">(</span><span class="yellow">window</span><span class="require">.</span><span class="new">ApplePaySession</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-6 function">var </span><span class="white">merchantIdentifier </span><span class="require">= '</span><span class="green">merchant.identificador</span><span class="require">';</span>
                                        <br>
                                            <span class="pl-6 function">var </span><span class="white">promise </span><span class="require">= </span><span class="yellow">ApplePaySession</span><span class="require">.</span><span class="new">canMakePaymentsWithActiveCard</span><span class="require">(</span><span class="white">merchantIdentifier</span><span class="require">);</span>
                                        <br>
                                            <span class="pl-6 white">promise</span><span class="require">.</span><span class="new">then</span><span class="require">(</span><span class="function">function</span><span class="require">(</span><span class="orange">canMakePayments</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-7 purple">if </span><span class="require">(</span><span class="white">canMakePayments</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-8">$</span><span class="require">('</span><span class="green">#applePay</span><span class="require">').</span><span class="new">show</span><span class="require">();</span>
                                        <br>
                                            <span class="pl-7 require">}</span>
                                        <br>
                                            <span class="pl-6 require">});</span>
                                        <br>
                                            <span class="pl-5 require">} </span><span class="purple">else </span><span class="require">{</span>
                                        <br>
                                            <span class="pl-6">$</span><span class="require">('</span><span class="green">#applePay</span><span class="require">').</span><span class="new">after</span><span class="require">('</span><span class="green">Apple Pay no es compatible con el navegador actual</span><span class="require">');</span>
                                        <br>
                                            <span class="pl-5 require">} </span>
                                        <br>
                                        <br>
                                            <span class="pl-5">$</span><span class="require">('</span><span class="green">#applePay</span><span class="require">').</span><span class="new">click</span><span class="require">(</span><span class="function">function</span><span class="require">(</span><span class="orange">event</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-6 comments">// Datos del pedido</span>
                                        <br>
                                            <span class="pl-6 function">var </span><span class="white">paymentRequest </span><span class="require">= {</span>
                                        <br>
                                            <span class="pl-8 new">currencyCode</span><span class="require">: '</span><span class="green">EUR</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-8 new">countryCode</span><span class="require">: '</span><span class="green">ES</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-8 new">total</span><span class="require">: {</span>
                                        <br>
                                            <span class="pl-9 new">label</span><span class="require">: '</span><span class="green">Addon Payments</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-9 new">amount</span><span class="require">: '</span><span class="green">10</span><span class="require">'</span>
                                        <br>
                                            <span class="pl-8 require">},</span>
                                        <br>
                                            <span class="pl-8 new">supportedNetworks</span><span class="require">: ['</span><span class="green">amex</span><span class="require">', '</span><span class="green">discover</span><span class="require">', '</span><span class="green">masterCard</span><span class="require">', '</span><span class="green">visa</span><span class="require">'],</span>
                                        <br>
                                            <span class="pl-8 new">merchantCapabilities</span><span class="require">: ['</span><span class="green">supports3DS</span><span class="require">', '</span><span class="green">supportsCredit</span><span class="require">', '</span><span class="green">supportsDebit</span><span class="require">'],</span>
                                        <br>
                                            <span class="pl-8 new">requiredShippingAddressFields</span><span class="require">: ['</span><span class="green">postalAddress</span><span class="require">']</span>
                                        <br>
                                            <span class="pl-6 require">};</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">// Indicamos la versión de Apple Pay que queremos usar</span>
                                        <br>
                                            <span class="pl-6 function">var </span><span class="white">session </span><span class="require">= </span><span class="new">new </span><span class="white">ApplePaySession</span><span class="require">(</span><span class="orange">1</span><span class="require">, </span><span class="white">paymentRequest</span><span class="require">);</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">// Enviamos la solicitud de sesión a nuestro archivo del servidor</span>
                                        <br>
                                            <span class="pl-6 function">function </span><span class="new">getSession</span><span class="require">(</span><span class="orange">url</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-7 function">return </span><span class="new">new </span><span class="yellow">Promise</span><span class="require">(</span><span class="function">function</span><span class="require">(</span><span class="orange">resolve</span><span class="require">, </span><span class="orange">reject</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-8">$</span><span class="require">.</span><span class="new">ajax</span><span class="require">({</span>
                                        <br>
                                            <span class="pl-9 new">url</span><span class="require">: '</span><span class="green">session.php</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-9 new">type</span><span class="require">: '</span><span class="green">POST</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-9 new">success</span><span class="require">: </span><span class="function">function</span><span class="require">(</span><span class="orange">data</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-10 function">return </span><span class="new">resolve</span><span class="require">(</span><span class="orange">JSON</span><span class="require">.</span><span class="new">parse</span><span class="require">(</span><span class="white">data</span><span class="require">));</span>
                                        <br>
                                            <span class="pl-9 require">},</span>
                                        <br>
                                            <span class="pl-9 new">error</span><span class="require">: </span><span class="function">function</span><span class="require">(</span><span class="orange">error</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-10 function">return </span><span class="white">reject</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-9 require">}</span>
                                        <br>
                                            <span class="pl-8 require">});</span>
                                        <br>
                                            <span class="pl-7 require">});</span>
                                        <br>
                                            <span class="pl-6 require">};</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">// comprobamos que el token del comercio es correcto</span>
                                        <br>
                                            <span class="pl-6 yellow">session</span><span class="require">.</span><span class="white">onvalidatemerchant </span><span class="require">= (</span><span class="orange">event</span><span class="require">) </span><span class="function">=> </span><span class="require">{</span>
                                        <br>
                                            <span class="pl-7 function">const </span><span class="white">validationURL </span><span class="require">= </span><span class="white">event</span><span class="require">.</span><span class="new">validationURL</span><span class="require">;</span>
                                        <br>
                                            <span class="pl-7 function">var </span><span class="white">promise </span><span class="require">= </span><span class="new">getSession</span><span class="require">(</span><span class="white">event</span><span class="require">.</span><span class="new">validationURL</span><span class="require">);</span>
                                        <br>
                                            <span class="pl-7 white">promise</span><span class="require">.</span><span class="new">then</span><span class="require">(</span><span class="function">function</span><span class="require">(</span><span class="orange">response</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-8 white">session</span><span class="require">.</span><span class="new">completeMerchantValidation</span><span class="require">(</span><span class="white">response</span><span class="require">) ;</span>
                                        <br>
                                            <span class="pl-7 require">});</span>
                                        <br>
                                            <span class="pl-6 require">};</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">// session.oncancel cuando el usuario descarta la modalidad de pago</span>
                                        <br>
                                            <span class="pl-6 yellow">session</span><span class="require">.</span><span class="white">oncancel </span><span class="require">= (</span><span class="orange">event</span><span class="require">) </span><span class="function">=> </span><span class="require">{</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 require">};</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">/**</span>
                                        <br>
                                            <span class="pl-6 comments">* Autorización</span>
                                        <br>
                                            <span class="pl-6 comments">* Aquí recibirá el token. Puede enviar el token a su servidor</span>
                                        <br>
                                            <span class="pl-6 comments">* donde se aloja el archivo que procesa la transacción con la pasarela de pagos</span>
                                        <br>
                                            <span class="pl-6 comments">* y le devuelve "status in session.completePayment()"</span>
                                        <br>
                                            <span class="pl-6 comments">*/</span>
                                        <br>
                                            <span class="pl-6 yellow">session</span><span class="require">.</span><span class="white">onpaymentauthorized </span><span class="require">= (</span><span class="orange">event</span><span class="require">) </span><span class="function">=> </span><span class="require">{</span>
                                        <br>
                                            <span class="pl-7 function">const </span><span class="white">token </span><span class="require">= </span><span class="white">event</span><span class="require">.</span><span class="new">payment</span><span class="require">.</span><span class="new">token</span><span class="require">.</span><span class="new">paymentData</span><span class="require">;</span>
                                        <br>
                                        <br>
                                            <span class="pl-7 comments">// Convertimos a JSON el token recibido</span>
                                        <br>
                                            <span class="pl-7 function">var </span><span class="white">datos </span><span class="require">= </span><span class="orange">JSON</span><span class="require">.</span><span class="new">stringify</span><span class="require">(</span><span class="white">token</span><span class="require">);</span>
                                        <br>
                                        <br>
                                            <span class="pl-7 comments">// Petición AJAX que envía los datos del token a su servidor</span>
                                        <br>
                                            <span class="pl-7">$</span><span class="require">.</span><span class="new">ajax</span><span class="require">({</span>
                                        <br>
                                            <span class="pl-8 new">url</span><span class="require">: '</span><span class="green">Authorization.php</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-8 new">type</span><span class="require">: '</span><span class="green">POST</span><span class="require">',</span>
                                        <br>
                                            <span class="pl-8 new">data</span><span class="require">: {</span><span class="new">misDatos</span><span class="require">:</span><span class="white">datos</span><span class="require">},</span>
                                        <br>
                                            <span class="pl-8 new">success</span><span class="require">: </span><span class="function">function</span><span class="require">(</span><span class="orange">data</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-9 function">if</span><span class="require">(</span><span class="white">data</span><span class="require">.</span><span class="new">respuesta</span><span class="require"> == '</span><span class="green">00</span><span class="require">') {</span>
                                        <br>
                                            <span class="pl-10 comments">// Si la transacción es correcta (00), indicamos al modal que la transacción es correcta</span>
                                        <br>
                                            <span class="pl-10 white">session</span><span class="require">.</span><span class="new">completePayment</span><span class="require">(</span><span class="yellow">ApplePaySession</span><span class="require">.</span><span class="new">STATUS_SUCCESS</span><span class="require">);</span>
                                        <br>
                                            <span class="pl-9 require">} </span><span class="function">else </span><span class="require">{</span>
                                        <br>
                                            <span class="pl-10 comments">// Si la transacción no es correcta, indicamos al modal que la transacción no se ha podido procesar</span>
                                        <br>
                                            <span class="pl-10 white">session</span><span class="require">.</span><span class="new">completePayment</span><span class="require">(</span><span class="yellow">ApplePaySession</span><span class="require">.</span><span class="new">STATUS_FAILURE</span><span class="require">);</span>
                                        <br>
                                            <span class="pl-9 require">}</span>
                                        <br>
                                            <span class="pl-8 require">},</span>
                                        <br>
                                            <span class="pl-8 new">error</span><span class="require">: </span><span class="function">function</span><span class="require">(</span><span class="orange">error</span><span class="require">) {</span>
                                        <br>
                                            <span class="pl-9">$</span><span class="require">('</span><span class="green">#server-results</span><span class="require">').</span><span class="new">html</span><span class="require">('</span><span class="green">Error al procesar su solicitud</span><span class="require">');</span>
                                        <br>
                                            <span class="pl-8 require">}</span>
                                        <br>
                                            <span class="pl-7 require">});</span>
                                        <br>
                                            <span class="pl-6 require">};</span>
                                        <br>
                                        <br>
                                            <span class="pl-6 comments">// Muestra el modal de Apple Pay</span>
                                        <br>
                                            <span class="pl-6 white">session</span><span class="require">.</span><span class="new">begin</span><span class="require">();</span>
                                        <br>
                                            <span class="pl-5 require">});</span>
                                        <br>
                                            <span class="pl-4 require">});</span>
                                        <br>
                                            <span class="pl-2 new">&lt;</span><span class="script">/script</span><span class="new">&gt;</span>

                                        <br>
                                        <br>
                                            
                                    </code>
                                </div>
							</div>            
						</div>
						<!-- /Punto 1-->

                        <!-- Punto 2-->
                        <div class="contenedor">
                            <div class="col-lg-12" >
                                <div class="pl-3 pt-3 pr-3 text-justify">
                                    <h3 class="pt-1" id="certificados">
                                        2. Certificados
                                    </h3>
                                    
                                    <hr>
                                    <p>
                                        Para poder utilizar Apple Pay, debe generar los certificados de Comerciante y validar su dominio siguiendo la <a target="_blank" href="https://developer.apple.com/documentation/apple_pay_on_the_web">guía de desarrolladores de ApplePay.</a> 
                                    </p>

                                    <p>
                                        Lo primero que necesita es una cuenta de desarrollador de Apple. También necesitará un ID de comercio de Apple que puede obtener siguiendo los <a target="_blank" href="https://appleid.apple.com/account?appId=632&returnUrl=https://developer.apple.com/account/resources/#!&page=create">pasos de registro</a>.
                                    </p>

                                    <br>

                                    <h4>
                                        Crear y cargar un certificado de Apple Pay
                                    </h4>

                                    <p>
                                        Este paso implica descargar un CSR (certificate signing request) desde el panel de administración de Addon Payments y cargarlo en Apple. Esto creará el certificado de Apple Pay necesario. A continuación, puede volver a cargar este certificado en el panel de administración para que pueda procesar las autorizaciones de Apple Pay con su ID de cliente de Addon Payments.
                                    </p>

                                    <h5 class="pt-4" id="obtCsr">2.1 Obtener el certificado CSR</h5>

                                    <hr>

                                    <p>
                                        En el panel de administración, menú “Config. de Cliente”, clickamos en la sección de Apple Pay y en “Obtener CSR”. El certificado se descargará automáticamente.
                                    </p>

                                    <img class="img-fluid mx-auto d-block" src="../../assets/img/csr.png" alt="imageCSR" style="width: 80%;">

                                    <h5 class="pt-4" id="upCsr">2.2 Subir el CSR</h5>

                                    <hr>

                                    <p>
                                        Entramos en el enlace <a target="_blank" href="https://developer.apple.com/account/ios/certificate/certificateCreate.action">https://developer.apple.com/account/ios/certificate/certificateCreate.action</a> y pulsamos en la sección “Apple Pay Payment Processing Certificate”. Se le pedirá que cargue su archivo CSR desde Addon Payments. Seleccione el archivo descargado y continúe. Finalmente le dará la opción de descargar el certificado de Apple Pay
                                    </p>

                                    <h5 class="pt-4" id="upCsrAddon">2.3 Subir el CSR en el panel de administración</h5>

                                    <hr>

                                    <p>
                                        Ya en el panel de administración de Addon Payments, subimos el certificado de Apple Pay.
                                    </p>

                                    <img class="img-fluid mx-auto d-block" src="../../assets/img/csr2.png" alt="imageCSR" style="width: 80%;">

                                    <p class="pt-4 pb-2">
                                        <small class="form-text text-muted alert alert-primary">
                                            --&gt; Una vez haya subido el certificado al panel de administración y haya seguido la documentación de Apple para crear los certificados que se solicitan en Apple Pay, podrá realizar operaciones desde su página web.
                                        </small>
                                    </p>
                                    
                                </div>
                            </div>            
                        </div>
                        <!-- /Punto 2-->

                        <!-- Punto 3 -->
                        <div class="contenedor">
							<div class="col-lg-12" >
                                <div class="pl-3 pt-3 pr-3 text-justify">
                                    <h3 class="pt-1" id="btnApplePay">
                                        3. Botón de ejemplo
                                    </h3>
                                    
                                    <hr>
                                    <p>
                                        Los siguientes botones le permiten realizar una operación válida y una operación denegada.
                                    </p>
                                    <ul>
                                        <li>Para realizar una operación correcta en entorno de pruebas, el valor del importe que debe enviar es '10'.</li>
                                        <li>Para realizar una operación denegada en entorno de pruebas, el valor del importe que debe enviar es '11.01'.</li>
                                    </ul>

                                    <hr>

                                    <form id="formulario_envio" method="POST" autocomplete="off" class="col-lg-12" action="Authorization.php">
                                        <div class="row justify-content-end">
                                            <div class="col-lg-11 text-center">
                                                <div class="row">
                                                    <div class="col-lg-5 mt-2 mb-2 formulario">
                                                        <p style="padding-top:10px;">
                                                            <input type="hidden" id="importe" name="importe" value="10" />
                                                            <b>Importe:</b> <span>10€ - Operación aceptada</span>
                                                        </p>
                                                        <!-- Datos de tarjeta -->
                                                        <div class="form-group row">
                                                            <div class="col-sm-12">
    															<div id="botonApple">
    																<a lang="es" class="btn btn-block" id="applePay" title="Start Apple Pay" role="link" tabindex="0"></a>
    															</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-lg-5 mt-2 mb-2 ml-lg-5 formulario">
                                                        <p style="padding-top:10px;">
                                                            <input type="hidden" id="importe" name="importe" value="10" />
                                                            <b>Importe:</b> <span>11.01€ - Operación denegada</span>
                                                        </p>
                                                        <!-- Datos de tarjeta -->
                                                        <div class="form-group row">
                                                            <div class="col-sm-12">
                                                                <div id="botonApple2">
                                                                    <a lang="es" class="btn btn-block" id="applePay2" title="Start Apple Pay" role="link" tabindex="0"></a>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>

                                    <hr>

                                    <h5 id="respuestaForm">
                                        3.2 Respuesta de la operación
                                    </h5>

                                    <div id="server-results" class="pb-3 mb-2">
                                        <p id="rspMsg">
                                            Su respuesta aparecerá aquí.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <!-- /Punto 3 -->
                        </div>
                    <!-- /Contenido común -->
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
        <script src="../../assets/js/barraprogreso.js"></script>
    </body>
</html>